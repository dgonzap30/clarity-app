import { useState, useEffect, useMemo, useCallback } from 'react';
import { ThemeProvider } from '@/components/ThemeProvider';
import { Header } from '@/components/Header';
import { TotalHeroCard } from '@/components/dashboard/TotalHeroCard';
import { BudgetHeroCard } from '@/components/dashboard/BudgetHeroCard';
import { BudgetCategoryCard } from '@/components/dashboard/BudgetCategoryCard';
import { NonBudgetedHeroCard } from '@/components/dashboard/NonBudgetedHeroCard';
import { NonBudgetedCategoryCard } from '@/components/dashboard/NonBudgetedCategoryCard';
import { CompactStatsBar } from '@/components/dashboard/CompactStatsBar';
import { AllCategoriesSpending } from '@/components/dashboard/AllCategoriesSpending';
import { MonthlyTrendChart } from '@/components/dashboard/MonthlyTrendChart';
import { DashboardSkeleton } from '@/components/dashboard/DashboardSkeleton';
import { TransactionList } from '@/components/transactions/TransactionList';
import {
  SubscriptionsHeroCard,
  SubscriptionGrid,
  UpcomingRenewals,
} from '@/components/subscriptions';
import { CSVUploadModal } from '@/components/modals/CSVUploadModal';
import { CategoryDetailModal } from '@/components/modals/CategoryDetailModal';
import { SettingsModal } from '@/components/modals/SettingsModal';
import { PDFExport } from '@/components/PDFExport';
import { Tabs, TabsContent, TabsList, TabsTrigger } from '@/components/ui/tabs';
import { parseCSV } from '@/lib/csv-parser';
import { loadTransactions, saveTransactions } from '@/lib/storage';
import { downloadJSON, downloadCSV } from '@/lib/export';
import { useSettings } from '@/hooks/useSettings';
import { useCategories } from '@/hooks/useCategories';
import { useSubscriptions } from '@/hooks/useSubscriptions';
import type { Transaction, Category } from '@/types';

function App() {
  const [transactions, setTransactions] = useState<Transaction[]>([]);
  const [loading, setLoading] = useState(true);
  const [selectedMonth, setSelectedMonth] = useState(new Date());
  const [uploadModalOpen, setUploadModalOpen] = useState(false);
  const [settingsModalOpen, setSettingsModalOpen] = useState(false);
  const [selectedCategory, setSelectedCategory] = useState<Category | null>(null);
  const [pdfExportRef, setPdfExportRef] = useState<HTMLDivElement | null>(null);

  // Settings hook
  const settingsHook = useSettings();

  // Categories hook - provides dynamic categories (default + custom)
  const { categories, categoryList } = useCategories(settingsHook.settings);

  // Subscriptions hook - provides subscription detection and management
  const subscriptionsHook = useSubscriptions(
    transactions,
    settingsHook.settings,
    settingsHook.updateSettings
  );

  useEffect(() => {
    async function loadData() {
      try {
        // Try loading from localStorage first
        const stored = loadTransactions();
        if (stored && stored.length > 0) {
          setTransactions(stored);
          setLoading(false);
          return;
        }

        // Fall back to CSV fetch if no stored data
        const response = await fetch('/data/centurion.csv');
        const csvContent = await response.text();
        const parsed = parseCSV(csvContent);
        setTransactions(parsed);
      } catch (error) {
        console.error('Failed to load transactions:', error);
      } finally {
        setLoading(false);
      }
    }
    loadData();
  }, []);

  // Save transactions to localStorage whenever they change
  useEffect(() => {
    if (transactions.length > 0) {
      saveTransactions(transactions);
    }
  }, [transactions]);

  const handleCSVUpload = (newTransactions: Transaction[]) => {
    setTransactions(newTransactions);
    // Transactions will be auto-saved via useEffect
  };

  const handleDeleteTransaction = (id: string) => {
    setTransactions((prev) => prev.filter((t) => t.id !== id));
  };

  const handleUpdateTransaction = useCallback((id: string, updates: Partial<Transaction>) => {
    setTransactions((prev) =>
      prev.map((t) => (t.id === id ? { ...t, ...updates } : t))
    );

    // Learn pattern if category changed and pattern learning is enabled
    if (updates.category && settingsHook.settings.preferences.enablePatternLearning) {
      const transaction = transactions.find((t) => t.id === id);
      if (transaction && transaction.merchant) {
        settingsHook.learnPattern(transaction.merchant, updates.category.id);
      }
    }
  }, [transactions, settingsHook]);

  const handleExportPDF = () => {
    if (pdfExportRef) {
      // Trigger PDF export - the PDFExport component will handle it
      const event = new CustomEvent('trigger-pdf-export');
      window.dispatchEvent(event);
    }
  };

  const handleExportJSON = useCallback(() => {
    downloadJSON(transactions);
  }, [transactions]);

  const handleExportCSV = useCallback(() => {
    downloadCSV(transactions);
  }, [transactions]);

  // Filter transactions for selected month
  const monthTransactions = useMemo(() => {
    return transactions.filter(
      (t) =>
        t.date.getMonth() === selectedMonth.getMonth() &&
        t.date.getFullYear() === selectedMonth.getFullYear()
    );
  }, [transactions, selectedMonth]);

  // Get budgeted categories based on settings
  const budgetedCategories = useMemo(() => {
    return categoryList.filter(
      (c) => settingsHook.settings.budgets[c.id]?.enabled
    );
  }, [categoryList, settingsHook.settings.budgets]);

  // Get non-budgeted categories based on settings
  const nonBudgetedCategories = useMemo(() => {
    return categoryList.filter(
      (c) => !settingsHook.settings.budgets[c.id]?.enabled
    );
  }, [categoryList, settingsHook.settings.budgets]);

  // Keyboard shortcuts
  useEffect(() => {
    const handleKeyDown = (e: KeyboardEvent) => {
      // Don't trigger shortcuts when typing in inputs
      if (e.target instanceof HTMLInputElement || e.target instanceof HTMLTextAreaElement) {
        return;
      }

      const isMeta = e.metaKey || e.ctrlKey;

      if (isMeta && e.key === 'u') {
        e.preventDefault();
        setUploadModalOpen(true);
      } else if (isMeta && e.key === ',') {
        e.preventDefault();
        setSettingsModalOpen(true);
      } else if (e.key === 'ArrowLeft' && !isMeta) {
        e.preventDefault();
        setSelectedMonth((prev) => {
          const newDate = new Date(prev);
          newDate.setMonth(newDate.getMonth() - 1);
          return newDate;
        });
      } else if (e.key === 'ArrowRight' && !isMeta) {
        e.preventDefault();
        setSelectedMonth((prev) => {
          const newDate = new Date(prev);
          newDate.setMonth(newDate.getMonth() + 1);
          return newDate;
        });
      }
    };

    window.addEventListener('keydown', handleKeyDown);
    return () => window.removeEventListener('keydown', handleKeyDown);
  }, []);

  if (loading) {
    return (
      <ThemeProvider defaultTheme="dark">
        <div className="min-h-screen bg-background">
          <Header
            selectedMonth={selectedMonth}
            onMonthChange={setSelectedMonth}
            onUploadClick={() => {}}
            onExportPDF={() => {}}
            onExportJSON={() => {}}
            onExportCSV={() => {}}
            onSettingsClick={() => {}}
            userName={settingsHook.settings.preferences.userName}
            enableGreetings={settingsHook.settings.preferences.enableGreetings}
          />
          <main className="container mx-auto p-4 sm:p-6 max-w-screen-2xl">
            <DashboardSkeleton />
          </main>
        </div>
      </ThemeProvider>
    );
  }

  return (
    <ThemeProvider defaultTheme="dark">
      <div className="min-h-screen bg-background">
        {/* Skip link for keyboard accessibility */}
        <a
          href="#main-content"
          className="skip-link"
        >
          Skip to main content
        </a>
        <Header
          selectedMonth={selectedMonth}
          onMonthChange={setSelectedMonth}
          onUploadClick={() => setUploadModalOpen(true)}
          onExportPDF={handleExportPDF}
          onExportJSON={handleExportJSON}
          onExportCSV={handleExportCSV}
          onSettingsClick={() => setSettingsModalOpen(true)}
          userName={settingsHook.settings.preferences.userName}
          enableGreetings={settingsHook.settings.preferences.enableGreetings}
        />
        <main id="main-content" className="container mx-auto p-4 sm:p-6 max-w-screen-2xl">
          <Tabs defaultValue="overview" className="space-y-6">
            <div className="flex justify-center">
              <TabsList>
                <TabsTrigger value="overview">Overview</TabsTrigger>
                <TabsTrigger value="budget">Budget</TabsTrigger>
                <TabsTrigger value="non-budgeted">Non-Budgeted</TabsTrigger>
                <TabsTrigger value="subscriptions">Subscriptions</TabsTrigger>
                <TabsTrigger value="transactions">Transactions</TabsTrigger>
              </TabsList>
            </div>

            {/* Overview Tab - Total spending at a glance */}
            <TabsContent value="overview" className="space-y-6" ref={setPdfExportRef}>
              {/* Total Hero Card - Shows all spending with budgeted vs non-budgeted split */}
              <TotalHeroCard
                transactions={transactions}
                month={selectedMonth}
                budgetedCategories={budgetedCategories}
                nonBudgetedCategories={nonBudgetedCategories}
                onUploadClick={() => setUploadModalOpen(true)}
              />

              {/* Compact Stats Bar */}
              <CompactStatsBar transactions={monthTransactions} allTransactions={transactions} />

              {/* Two column: All Categories + Trend */}
              <div className="grid gap-4 sm:gap-6 grid-cols-1 md:grid-cols-2 items-stretch">
                <AllCategoriesSpending
                  transactions={monthTransactions}
                  categories={categoryList}
                  onCategoryClick={setSelectedCategory}
                />
                <MonthlyTrendChart
                  transactions={transactions}
                  categories={categories}
                  categoryList={categoryList}
                  compact
                />
              </div>

              {/* PDF Export - hidden but available for export */}
              <div className="hidden">
                <PDFExport />
              </div>
            </TabsContent>

            {/* Budget Tab - Only budgeted categories */}
            <TabsContent value="budget" className="space-y-6">
              {/* Budget Hero - Budget status and projections */}
              <BudgetHeroCard
                transactions={transactions}
                month={selectedMonth}
                settings={settingsHook.settings}
              />

              {/* Budgeted Categories */}
              <div className="grid gap-4 sm:gap-6 grid-cols-1 sm:grid-cols-2">
                {budgetedCategories.map((category, index) => (
                  <div
                    key={category.id}
                    className="animate-card-enter"
                    style={{ animationDelay: `${index * 75}ms` }}
                  >
                    <BudgetCategoryCard
                      category={category}
                      transactions={transactions}
                      month={selectedMonth}
                      budget={settingsHook.settings.budgets[category.id]?.amount || 0}
                      onClick={() => setSelectedCategory(category)}
                    />
                  </div>
                ))}
              </div>

              {/* Monthly trend filtered to budgeted only */}
              <MonthlyTrendChart
                transactions={transactions}
                categories={categories}
                categoryList={categoryList}
                categoryFilter="budgeted"
                compact
              />
            </TabsContent>

            {/* Non-Budgeted Tab - Only non-budgeted categories */}
            <TabsContent value="non-budgeted" className="space-y-6">
              {/* Non-Budgeted Hero - Summary and trends */}
              <NonBudgetedHeroCard
                transactions={transactions}
                month={selectedMonth}
                nonBudgetedCategories={nonBudgetedCategories}
              />

              {/* Non-Budgeted Categories */}
              <div className="grid gap-3 sm:gap-4 grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 auto-rows-fr">
                {nonBudgetedCategories.map((category, index) => (
                  <div
                    key={category.id}
                    className="animate-card-enter"
                    style={{ animationDelay: `${index * 50}ms` }}
                  >
                    <NonBudgetedCategoryCard
                      category={category}
                      transactions={transactions}
                      month={selectedMonth}
                      onClick={() => setSelectedCategory(category)}
                    />
                  </div>
                ))}
              </div>

              {/* Monthly trend filtered to non-budgeted only */}
              <MonthlyTrendChart
                transactions={transactions}
                categories={categories}
                categoryList={categoryList}
                categoryFilter="non-budgeted"
              />
            </TabsContent>

            {/* Subscriptions Tab - Recurring subscription management */}
            <TabsContent value="subscriptions" className="space-y-6">
              {/* Subscriptions Hero - Summary stats */}
              <SubscriptionsHeroCard
                totalMonthlySpend={subscriptionsHook.totalMonthlySpend}
                annualProjection={subscriptionsHook.annualProjection}
                activeCount={subscriptionsHook.activeCount}
                upcomingRenewals={subscriptionsHook.upcomingRenewals}
                onRefresh={subscriptionsHook.runDetection}
                isDetecting={subscriptionsHook.isDetecting}
              />

              {/* Two column layout: Grid + Upcoming */}
              <div className="grid gap-4 sm:gap-6 grid-cols-1 lg:grid-cols-3">
                {/* Main subscription grid */}
                <div className="lg:col-span-2">
                  <SubscriptionGrid subscriptions={subscriptionsHook.subscriptions} />
                </div>

                {/* Upcoming renewals sidebar */}
                <UpcomingRenewals renewals={subscriptionsHook.upcomingRenewals} />
              </div>
            </TabsContent>

            {/* Transactions Tab - Detailed transaction list */}
            <TabsContent value="transactions" className="space-y-6">
              <TransactionList
                transactions={monthTransactions}
                selectedMonth={selectedMonth}
                onDeleteTransaction={handleDeleteTransaction}
                onUpdateTransaction={handleUpdateTransaction}
                confirmDestructive={settingsHook.settings.preferences.confirmDestructiveActions}
                categories={categories}
              />
            </TabsContent>
          </Tabs>
        </main>

        {/* CSV Upload Modal */}
        <CSVUploadModal
          open={uploadModalOpen}
          onOpenChange={setUploadModalOpen}
          onUpload={handleCSVUpload}
          existingTransactions={transactions}
          defaultUploadMode={settingsHook.settings.preferences.defaultUploadMode}
        />

        {/* Category Detail Modal */}
        <CategoryDetailModal
          category={selectedCategory}
          transactions={monthTransactions}
          onClose={() => setSelectedCategory(null)}
          budget={selectedCategory ? settingsHook.settings.budgets[selectedCategory.id] : undefined}
        />

        {/* Settings Modal */}
        <SettingsModal
          open={settingsModalOpen}
          onOpenChange={setSettingsModalOpen}
          settingsHook={settingsHook}
        />
      </div>
    </ThemeProvider>
  );
}

export default App;
